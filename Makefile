SHELL := /bin/bash

.PHONY: clean # clean files generated by make install/test_run
clean:
	-rm -rf build/ dist/ hecat.egg-info/ awesome-selfhosted awesome-selfhosted-data

.PHONY: install # install in a virtualenv
install:
	python3 -m venv .venv && source .venv/bin/activate && \
	pip3 install wheel && \
	python3 setup.py install

##### TESTS #####

.PHONY: test # run tests
test: test_pylint test_import_as test_process_as test_export_as

.PHONY: test_pylint # run linter (non blocking)
test_pylint: install
	-source .venv/bin/activate && \
	pip3 install pylint pyyaml && \
	pylint --disable=too-many-locals hecat

.PHONY: clone_as # clone awesome-selfhosted/awesome-selfhosted-data
clone_as:
	git clone --depth=1 https://github.com/awesome-selfhosted/awesome-selfhosted
	git clone https://github.com/awesome-selfhosted/awesome-selfhosted-data

.PHONY: test_import_as # test import from awesome-sefhosted
test_import_as: clean install clone_as
	rm -r awesome-selfhosted-data/{tags,software,platforms}
	mkdir awesome-selfhosted-data/{tags,software,platforms}
	source .venv/bin/activate && \
	hecat --config tests/.hecat.import.yml && \
	hecat --config tests/.hecat.github_metadata.yml

.PHONY: test_process_as # test processing on awesome-selfhosted-data
test_process_as: install
	source .venv/bin/activate && \
	hecat --config tests/.hecat.github_metadata.yml && \
	hecat --config tests/.hecat.awesome_lint.yml
	cd awesome-selfhosted-data && git --no-pager diff --color=always

.PHONY: test_export_as # test export to singlepage markdown from awesome-selfhosted-data
test_export_as: install
	source .venv/bin/activate && \
	hecat --config tests/.hecat.export_markdown_singlepage.yml && \
	cd awesome-selfhosted && git --no-pager diff --color=always
